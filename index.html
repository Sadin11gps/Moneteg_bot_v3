<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Earning ~√ó‚Ä¢RDS TEAM‚Ä¢√ó~</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <style>
        /* Google Font Import */
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap');

        /* CSS Variables for Theming */
        :root {
            --font-family: 'Nunito', sans-serif;
            --bg-color: #121212; /* Dark theme background */
            --secondary-bg: #1e1e1e;
            --text-color: #ffffff;
            --subtle-text: #b0b0b0;
            --primary-color: #3498db; /* Blue */
            --accent-color: #f39c12; /* Orange */
            --sparkle-color: #e74c3c; /* Red/Sparkle */
            --success-color: #2ecc71; /* Green */
            --danger-color: #e74c3c; /* Red */
            --glow-shadow: 0 0 10px rgba(231, 76, 60, 0.4);
            --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --border-radius: 12px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding-bottom: 70px; /* Space for fixed bottom navigation */
        }
        
        /* Utility Classes */
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mt-3 { margin-top: 0.75rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mr-2 { margin-right: 0.5rem; }
        .p-4 { padding: 1rem; }
        .text-center { text-align: center; }
        .font-bold { font-weight: 700; }
        .hidden { display: none !important; }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        /* Page Styling */
        .page {
            display: none;
            padding-top: 10px;
            min-height: calc(100vh - 80px); /* Adjust based on nav height */
        }
        .page.active {
            display: block;
        }

        /* Card and Box Styles */
        .card, .referral-box {
            background-color: var(--secondary-bg);
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            margin-bottom: 15px;
        }
        
        /* Profile Section */
        .profile-header {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #333;
            margin-bottom: 20px;
        }
        .user-photo-placeholder {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
            border: 3px solid var(--primary-color);
        }
        .user-info .user-name {
            font-size: 1.4rem;
            margin: 0;
            color: var(--sparkle-color);
        }
        .user-info .user-id-text {
            font-size: 0.8rem;
            color: var(--subtle-text);
            margin: 0;
        }
        
        /* Balance Section */
        .balance-section {
            display: flex;
            justify-content: space-around;
            text-align: center;
        }
        .balance-card {
            flex: 1;
            padding: 15px;
            margin: 0 5px;
            border-radius: var(--border-radius);
            background: #252525;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
        }
        .balance-label {
            font-size: 0.8rem;
            color: var(--subtle-text);
            margin-bottom: 5px;
        }
        .balance-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--success-color);
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        .stat-card {
            background-color: #252525;
            padding: 15px;
            border-radius: var(--border-radius);
            text-align: center;
            border-left: 5px solid var(--accent-color);
        }
        .stat-icon {
            color: var(--accent-color);
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        .stat-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: var(--sparkle-color);
        }
        .stat-label {
            font-size: 0.8rem;
            color: var(--subtle-text);
        }

        /* Buttons and Inputs */
        .btn-primary {
            display: block;
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            text-decoration: none;
            background-color: var(--primary-color);
            color: var(--text-color);
            box-shadow: 0 4px 10px rgba(52, 152, 219, 0.4);
        }

        .btn-primary:hover:not(:disabled) {
            background-color: #2980b9;
        }
        .btn-primary:disabled {
            background-color: #5d6d7e;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        /* Referral Input */
        .referral-input-group {
            display: flex;
            margin-bottom: 15px;
        }
        #referral-link-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 8px 0 0 8px;
            background-color: #2c2c2c;
            color: var(--text-color);
            font-size: 0.9rem;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .btn-copy {
            padding: 10px 15px;
            border-radius: 0 8px 8px 0;
            background-color: var(--accent-color);
            transition: background-color 0.3s;
        }
        .btn-copy:hover {
            background-color: #e67e22;
        }
        
        /* Task Page Specific */
        .ad-button-container {
            margin-top: 20px;
        }
        
        /* Withdraw Page Specific */
        .wallet-select-group {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }
        .wallet-select-group label {
            flex: 1;
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: #252525;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid #252525;
            transition: border-color 0.3s;
        }
        .wallet-select-group input[type="radio"]:checked + label {
            border-color: var(--primary-color);
            background-color: #1a1a1a;
        }
        .wallet-select-group input[type="radio"] {
            margin-right: 10px;
        }
        .wallet-select-group span {
            font-size: 0.9rem;
            font-weight: 600;
        }

        form label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--subtle-text);
        }
        form select, form input[type="text"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #444;
            border-radius: 8px;
            background-color: #2c2c2c;
            color: var(--text-color);
            font-size: 1rem;
        }
        
        .referral-check-box {
            border: 1px solid #444;
            border-left: 5px solid var(--danger-color);
            padding: 10px;
            border-radius: 8px;
            background-color: #1a1a1a;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        /* History Page Specific */
        .history-list {
            list-style: none;
            padding: 0;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            background-color: #1e1e1e;
            border-top: 1px solid #333;
            box-shadow: 0 -4px 10px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            max-width: 500px;
            margin: 0 auto;
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--subtle-text);
            padding: 10px 0;
            flex: 1;
            font-size: 0.7rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .nav-btn i {
            font-size: 1.2rem;
            margin-bottom: 4px;
        }

        .nav-btn.active {
            color: var(--sparkle-color);
            text-shadow: 0 0 5px rgba(231, 76, 60, 0.8);
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            transition: opacity 0.3s;
        }

        .modal-content {
            background-color: var(--secondary-bg);
            padding: 20px;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 400px;
            box-shadow: var(--glow-shadow);
            text-align: center;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .modal-body textarea {
            width: 100%;
            height: 150px;
            padding: 10px;
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 8px;
            color: var(--text-color);
            font-size: 0.9rem;
            resize: none;
        }
        
        /* Loader for Ad */
        .loader {
            border: 5px solid #333;
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body>
    <div class="container">
        
        <!-- ======================= HOME PAGE ======================= -->
        <div id="home-page" class="page active">
            <div class="profile-header">
                <img id="user-photo" src="https://placehold.co/60x60/3498db/ffffff?text=L" alt="User Photo" class="user-photo-placeholder">
                <div class="user-info">
                    <h1 class="user-name" id="user-name">Loading...</h1>
                    <p class="user-id-text">ID: <span id="user-id">Loading...</span></p>
                </div>
            </div>

            <!-- Balance Overview -->
            <div class="balance-section mb-4">
                <div class="balance-card">
                    <div class="balance-label">‡¶Æ‡ßã‡¶ü ‡¶Æ‡ßá‡¶á‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</div>
                    <div class="balance-value" id="main-balance">0.00 TK</div>
                </div>
                <div class="balance-card">
                    <div class="balance-label">‡¶Æ‡ßã‡¶ü ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</div>
                    <div class="balance-value" id="refer-balance">0.00 TK</div>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <i class="fas fa-users stat-icon"></i>
                    <div class="stat-value" id="total-referrals">0</div>
                    <div class="stat-label">‡¶Æ‡ßã‡¶ü ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-eye stat-icon"></i>
                    <div class="stat-value" id="daily-ads-watched">0</div>
                    <div class="stat-label">‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ï‡¶æ‡¶ú</div>
                </div>
            </div>

            <!-- Referral Link Box -->
            <div class="referral-box mt-4">
                <h3 style="color: var(--sparkle-color); margin-bottom: 10px;"><i class="fas fa-share-alt mr-2"></i> ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï</h3>
                <div class="referral-input-group">
                    <input type="text" id="referral-link-input" value="Loading Referral Link..." readonly>
                    <button id="copy-referral-btn" class="btn-copy">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
                <button id="generate-message-btn" class="btn-primary mt-3" style="background-color: #8e44ad;">
                    <i class="fas fa-lightbulb mr-2"></i> ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶® (Gemini AI)
                </button>
            </div>
        </div>
        
        <!-- ======================= TASK PAGE ======================= -->
        <div id="task-page" class="page">
            <h2 class="py-2" style="border-bottom: 1px solid #333;">‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶ï‡¶æ‡¶ú (Ads)</h2>

            <div class="card mt-4 text-center">
                <h3 style="color: var(--accent-color);"><i class="fas fa-ad"></i> ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶®</h3>
                <p style="color: var(--subtle-text); margin-top: 10px;">‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶®‡¶ø ‡¶™‡¶æ‡¶¨‡ßá‡¶® 5 TK‡•§</p>
                
                <div class="stat-card mt-3">
                    <i class="fas fa-calendar-day stat-icon"></i>
                    <div class="stat-value" id="task-ad-count">0</div>
                    <div class="stat-label">‡¶Ü‡¶ú ‡¶¶‡ßá‡¶ñ‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá</div>
                </div>

                <div class="ad-button-container mt-4">
                    <button id="watch-ad-btn" class="btn-primary" style="background-color: var(--success-color);">
                        <i class="fas fa-video mr-2"></i> ‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® (Watch Ad)
                    </button>
                    <p style="font-size: 0.8rem; color: var(--subtle-text); margin-top: 10px;">(‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶¶‡ßá‡¶ñ‡¶§‡ßá ‡ß© ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡¶§‡ßá ‡¶π‡¶¨‡ßá)</p>
                </div>
            </div>
            
            <!-- Moneteg Ad Display Area -->
            <div id="ad-container" class="mt-4">
                 <!-- Moneteg ad will be inserted here -->
            </div>
        </div>
        
        <!-- ======================= WITHDRAW PAGE ======================= -->
        <div id="withdraw-page" class="page">
            <h2 class="py-2" style="border-bottom: 1px solid #333;">‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®</h2>

            <div class="balance-card mt-4">
                <div class="balance-label">‡¶Æ‡ßã‡¶ü ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡ßá‡¶∞ ‡¶Ø‡ßã‡¶ó‡ßç‡¶Ø ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</div>
                <div class="balance-value" id="total-withdrawable-balance" style="color: var(--sparkle-color);">0.00 TK</div>
            </div>
            
            <div id="referral-check-block" class="referral-check-box mt-4">
                <p id="referral-check-text">‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞‡¶Ø‡¶º‡¶æ‡¶≤‡ßá‡¶∞ ‡¶∂‡¶∞‡ßç‡¶§ ‡¶Ø‡¶æ‡¶ö‡¶æ‡¶á ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
            </div>

            <p id="ref-status-notice" class="hidden" style="color: var(--danger-color); font-size: 0.9rem; text-align: center; margin-bottom: 15px;">
                <i class="fas fa-exclamation-triangle mr-2"></i> ‡¶∂‡¶∞‡ßç‡¶§ ‡¶™‡ßÇ‡¶∞‡¶£ ‡¶®‡¶æ ‡¶π‡¶ì‡¶Ø‡¶º‡¶æ ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶∏‡¶Æ‡ßç‡¶≠‡¶¨ ‡¶®‡¶Ø‡¶º‡•§
            </p>

            <form id="withdraw-form" class="card">
                <h3 style="color: var(--primary-color); margin-bottom: 20px;"><i class="fas fa-wallet"></i> ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡ßá‡¶∞ ‡¶´‡¶∞‡ßç‡¶Æ</h3>
                
                <label for="wallet-select" style="font-weight: bold; color: var(--text-color);">‡¶ï‡ßã‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶ï‡¶∞‡¶¨‡ßá‡¶®?</label>
                <div class="wallet-select-group">
                    <input type="radio" id="wallet-main" name="wallet" value="main" checked style="display: none;">
                    <label for="wallet-main">
                        <i class="fas fa-money-bill-wave mr-2" style="color: var(--success-color);"></i>
                        <div>
                            <span>‡¶Æ‡ßá‡¶á‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</span>
                            <p style="font-size: 0.7rem; color: var(--subtle-text); margin: 0;" id="main-balance-withdraw">0.00 TK</p>
                        </div>
                    </label>

                    <input type="radio" id="wallet-refer" name="wallet" value="refer" style="display: none;">
                    <label for="wallet-refer">
                        <i class="fas fa-gift mr-2" style="color: var(--sparkle-color);"></i>
                        <div>
                            <span>‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</span>
                            <p style="font-size: 0.7rem; color: var(--subtle-text); margin: 0;" id="refer-balance-withdraw">0.00 TK</p>
                        </div>
                    </label>
                </div>
                <!-- Hidden input to track selected wallet for form submission -->
                <input type="hidden" id="wallet-select" value="main"> 

                <label for="amount-input">‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ 500 TK)</label>
                <input type="text" id="amount-input" placeholder="‡¶ü‡¶æ‡¶ï‡¶æ‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶® (‡¶Ø‡ßá‡¶Æ‡¶®: 100, 200)">

                <label for="method-select">‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ ‡¶®‡¶ø‡¶∞‡ßç‡¶¨‡¶æ‡¶ö‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</label>
                <select id="method-select">
                    <option value="bkash">Bkash Personal</option>
                    <option value="nagad">Nagad Personal</option>
                    <option value="rocket">Rocket Personal</option>
                </select>

                <label for="number-input">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞</label>
                <input type="text" id="number-input" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶´‡ßã‡¶® ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶®">

                <button type="submit" id="withdraw-submit-btn" class="btn-primary mt-4" disabled>
                    <i class="fas fa-paper-plane mr-2"></i> ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß ‡¶™‡¶æ‡¶†‡¶æ‡¶®
                </button>
            </form>
        </div>

        <!-- ======================= HISTORY PAGE ======================= -->
        <div id="history-page" class="page">
            <h2 class="py-2" style="border-bottom: 1px solid #333;">‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡ßá‡¶∞ ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏</h2>
            <div id="history-list" class="history-list mt-4">
                <!-- History items will be loaded here by JavaScript -->
                <div class="card p-4 text-center">
                    <i class="fas fa-spinner fa-spin fa-2x" style="color: var(--primary-color);"></i>
                    <p class="mt-2" style="color: var(--subtle-text);">‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</p>
                </div>
            </div>
        </div>

        <!-- ======================= SUPPORT PAGE ======================= -->
        <div id="support-page" class="page">
            <h2 class="py-2" style="border-bottom: 1px solid #333;">‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ì ‡¶∏‡¶æ‡¶π‡¶æ‡¶Ø‡ßç‡¶Ø</h2>
            <div class="referral-box mt-4">
                <h3 style="color: var(--sparkle-color);"><i class="fas fa-question-circle"></i> ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®</h3>
                <p style="color: var(--subtle-text); margin-top: 10px;">‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶∏‡¶Æ‡ßç‡¶™‡¶∞‡ßç‡¶ï‡ßá ‡¶∏‡¶æ‡¶ß‡¶æ‡¶∞‡¶£ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®‡ßá‡¶∞ ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶ú‡¶æ‡¶®‡¶§‡ßá ‡¶¨‡¶æ ‡¶ï‡ßã‡¶®‡ßã ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ ‡¶¨‡¶æ‡¶ü‡¶®‡¶ü‡¶ø ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
                <a id="support-bot-link" href="#" target="_blank" class="btn-primary" style="background-color: #2980b9;">
                    <i class="fab fa-telegram-plane mr-2"></i> ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú
                </a>
            </div>
            
            <div class="referral-box mt-4">
                <h3 style="color: var(--sparkle-color);"><i class="fas fa-info-circle"></i> ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶§‡¶•‡ßç‡¶Ø</h3>
                <ul style="list-style: none; padding: 0; color: var(--subtle-text); font-size: 0.9rem;">
                    <li style="margin-bottom: 8px;"><i class="fas fa-check-circle mr-2" style="color: var(--accent-color);"></i> ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶™‡¶æ‡¶¨‡ßá‡¶® <span style="color: var(--sparkle-color); font-weight: bold;">30 TK</span>‡•§</li>
                    <li style="margin-bottom: 8px;"><i class="fas fa-check-circle mr-2" style="color: var(--accent-color);"></i> ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø <span style="color: var(--sparkle-color); font-weight: bold;">20 ‡¶ú‡¶® ‡¶∞‡ßá‡¶´‡¶æ‡¶∞</span> ‡¶Ü‡¶¨‡¶∂‡ßç‡¶Ø‡¶ø‡¶ï‡•§</li>
                    <li style="margin-bottom: 8px;"><i class="fas fa-check-circle mr-2" style="color: var(--accent-color);"></i> ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶°‡ßá‡¶ü‡¶æ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£‡¶∞‡ßÇ‡¶™‡ßá ‡¶®‡¶ø‡¶∞‡¶æ‡¶™‡¶¶‡•§</li>
                </ul>
            </div>
            
            <div class="referral-box mt-4">
                <h3 style="color: var(--sparkle-color);"><i class="fas fa-link"></i> ‡¶ó‡ßÅ‡¶∞‡ßÅ‡¶§‡ßç‡¶¨‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï</h3>
                <ul style="list-style: none; padding: 0; color: var(--subtle-text); font-size: 0.9rem;">
                    <li style="margin-bottom: 8px;"><i class="fas fa-bullhorn mr-2" style="color: var(--primary-color);"></i> <a id="channel-link-anchor" href="#" target="_blank" style="color: var(--primary-color); text-decoration: none;">‡¶Ö‡¶´‡¶ø‡¶∏‡¶ø‡¶Ø‡¶º‡¶æ‡¶≤ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤</a></li>
                    <li style="margin-bottom: 8px;"><i class="fas fa-users-cog mr-2" style="color: var(--primary-color);"></i> <a id="group-link-anchor" href="#" target="_blank" style="color: var(--primary-color); text-decoration: none;">‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶ó‡ßç‡¶∞‡ßÅ‡¶™</a></li>
                </ul>
            </div>
        </div>
        
        <!-- ======================= GEMINI MODAL ======================= -->
        <div id="gemini-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 style="color: var(--sparkle-color);"><i class="fas fa-lightbulb"></i> ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶∏‡ßá‡¶ú ‡¶§‡ßà‡¶∞‡¶ø</h3>
                    <button id="close-modal-btn" style="background: none; border: none; color: var(--text-color); font-size: 1.5rem; cursor: pointer;">&times;</button>
                </div>
                <div class="modal-body">
                    <p style="color: var(--subtle-text); font-size: 0.9rem; margin-bottom: 10px;">
                        ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶ï‡¶∞‡ßç‡¶∑‡¶£‡ßÄ‡ßü ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶∏‡ßá‡¶ú ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§
                    </p>
                    <textarea id="generated-message" readonly>
                        ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶∏‡ßá‡¶ú ‡¶≤‡ßã‡¶° ‡¶π‡¶¨‡ßá...
                    </textarea>
                    <button id="copy-generated-btn" class="btn-primary mt-3 btn-copy">
                        <i class="fas fa-copy"></i> ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ======================= AD LOADING MODAL ======================= -->
        <div id="loading-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="loader"></div>
                <p style="color: var(--text-color); margin-top: 15px;">‡¶¨‡¶ø‡¶ú‡ßç‡¶û‡¶æ‡¶™‡¶® ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá... ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§</p>
            </div>
        </div>

    </div> <!-- closes container -->

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="nav-btn active" data-page="home-page">
            <i class="fas fa-home"></i> ‡¶π‡ßã‡¶Æ
        </button>
        <button class="nav-btn" data-page="task-page">
            <i class="fas fa-clipboard-list"></i> ‡¶ï‡¶æ‡¶ú
        </button>
        <button class="nav-btn" data-page="withdraw-page">
            <i class="fas fa-wallet"></i> ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®
        </button>
        <button class="nav-btn" data-page="history-page">
            <i class="fas fa-history"></i> ‡¶á‡¶§‡¶ø‡¶π‡¶æ‡¶∏
        </button>
        <button class="nav-btn" data-page="support-page">
            <i class="fas fa-headset"></i> ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü
        </button>
    </div>

    <!-- Telegram Web App JS -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Moneteg Ad SDK - User requested -->
    <script src='//libtl.com/sdk.js' data-zone='10203066' data-sdk='show_10203066'></script> 
    
    <!-- ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶≤‡¶ø‡¶ï‡ßá‡¶∂‡¶® ‡¶≤‡¶ú‡¶ø‡¶ï (Local Storage-‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï) -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // CRITICAL FIX 1: Robust check for Telegram WebApp environment
            const tg = window.Telegram && window.Telegram.WebApp;
            const ALL_USERS_KEY = 'rds_team_all_users';

            if (!tg || !tg.initDataUnsafe || !tg.initDataUnsafe.user) {
                document.querySelector('.container').innerHTML = '<div class="card p-4 mt-4 text-center error-message" style="background-color: #4b1b1b; color: var(--danger-color);"><h2>‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™ ‡¶≤‡ßã‡¶° ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø</h2><p>‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶á ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶™‡¶ü‡¶ø ‡¶ü‡ßá‡¶≤‡¶ø‡¶ó‡ßç‡¶∞‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶•‡¶æ‡¶ï‡¶æ ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ï‡ßç‡¶≤‡¶ø‡¶ï ‡¶ï‡¶∞‡ßá ‡¶ñ‡ßÅ‡¶≤‡ßÅ‡¶®‡•§</p></div>';
                document.body.className = 'light-theme';
                document.querySelector('.bottom-nav').classList.add('hidden');
                return;
            }
            
            tg.ready(); tg.expand(); tg.setHeaderColor('#1e1e1e'); tg.setBackgroundColor('#121212');

            // --- Configuration (‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶§‡¶•‡ßç‡¶Ø ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá) ---
            const BOT_TOKEN = "8399242899:AAGUNCT8SnZ-oQhxgP_XCUCs4e-eMmAlNR0";
            const BOT_USERNAME = "vote_rds_bot"; 
            const ADMIN_CHAT_ID = "7702378694";
            const CHANNEL_LINK = "https://t.me/amrrdsteam";
            const GROUP_LINK = "https://t.me/smart_network81_group";
            const DAILY_AD_LIMIT = 20;
            const AD_POINT = 5; // Points per ad (changed from 1.00 points to 1.00 TK as seen in UI text)
            const REFERRAL_BONUS_TK = 40.00; // ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá 30 ‡¶ü‡¶æ‡¶ï‡¶æ
            const MIN_WITHDRAW_AMOUNT = 500;
            const MIN_REFERRALS_FOR_WITHDRAW = 20; // ‡¶â‡¶á‡¶•‡¶°‡ßç‡¶∞ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡ßÄ‡¶Ø‡¶º ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ
            
            const userId = tg.initDataUnsafe.user.id.toString();
            let userState = {};

            // Gemini Config (for referral message generation)
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=`;
            const API_KEY = "AIzaSyC5D4PgZEaRuLZIXm1I_SgVOl86TwH9iV0"; // Canvas runtime provides this

            // --- DOM Elements ---
            const userPhotoElem = document.getElementById('user-photo');
            const userNameElem = document.getElementById('user-name');
            const userIdElem = document.getElementById('user-id');
            const mainBalanceElem = document.getElementById('main-balance');
            const referBalanceElem = document.getElementById('refer-balance');
            const totalReferralsElem = document.getElementById('total-referrals'); 
            const dailyAdsWatchedElem = document.getElementById('daily-ads-watched');
            const taskAdCountElem = document.getElementById('task-ad-count');
            const referralLinkElem = document.getElementById('referral-link-input');
            const copyReferralBtn = document.getElementById('copy-referral-btn');
            const generateMessageBtn = document.getElementById('generate-message-btn');
            const watchAdBtn = document.getElementById('watch-ad-btn');
            const withdrawForm = document.getElementById('withdraw-form');
            const withdrawSubmitBtn = document.getElementById('withdraw-submit-btn');
            const amountInput = document.getElementById('amount-input');
            const methodSelect = document.getElementById('method-select');
            const numberInput = document.getElementById('number-input');
            const historyListElem = document.getElementById('history-list');
            const loadingModal = document.getElementById('loading-modal');
            const geminiModal = document.getElementById('gemini-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const generatedMessageTextarea = document.getElementById('generated-message');
            const copyGeneratedBtn = document.getElementById('copy-generated-btn');
            const supportBotLink = document.getElementById('support-bot-link');
            const channelLinkAnchor = document.getElementById('channel-link-anchor');
            const groupLinkAnchor = document.getElementById('group-link-anchor');
            const totalWithdrawableBalanceElem = document.getElementById('total-withdrawable-balance');
            const referralCheckBlock = document.getElementById('referral-check-block');
            const referralCheckText = document.getElementById('referral-check-text');
            const refStatusNotice = document.getElementById('ref-status-notice');
            const mainBalanceWithdraw = document.getElementById('main-balance-withdraw');
            const referBalanceWithdraw = document.getElementById('refer-balance-withdraw');
            const walletSelectHidden = document.getElementById('wallet-select');
            
            // --- Core Functions ---

            // CRITICAL FIX 2: Added utility for exponential backoff for fetch
            const MAX_RETRIES = 3;
            const fetchWithRetry = async (url, options, retries = 0) => {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response;
                } catch (error) {
                    if (retries < MAX_RETRIES) {
                        const delay = Math.pow(2, retries) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return fetchWithRetry(url, options, retries + 1);
                    }
                    console.error("Fetch failed after multiple retries:", error);
                    throw error;
                }
            };
            
            const loadState = () => {
                let allUsers = JSON.parse(localStorage.getItem(ALL_USERS_KEY) || '{}');

                // Migrate from old per-user storage if exists
                const oldSaved = localStorage.getItem('userState_' + userId);
                if (oldSaved && !allUsers[userId]) {
                    allUsers[userId] = JSON.parse(oldSaved);
                    localStorage.removeItem('userState_' + userId); // Clean up old key
                }

                userState = allUsers[userId] || {
                    id: userId,
                    name: tg.initDataUnsafe.user.first_name + ' ' + (tg.initDataUnsafe.user.last_name || ''),
                    username: tg.initDataUnsafe.user.username || null,
                    points: 0,
                    referral_points: 0,
                    referrals: [],
                    daily_ads_watched: 0,
                    last_ad_date: new Date().toDateString(),
                    history: [],
                    initial_referral_processed: false
                };

                allUsers[userId] = userState;
                localStorage.setItem(ALL_USERS_KEY, JSON.stringify(allUsers));

                // Daily reset
                const today = new Date().toDateString();
                if (userState.last_ad_date !== today) {
                    userState.daily_ads_watched = 0;
                    userState.last_ad_date = today;
                }

                saveState();
            };

            const saveState = () => {
                let allUsers = JSON.parse(localStorage.getItem(ALL_USERS_KEY) || '{}');
                allUsers[userId] = userState;
                localStorage.setItem(ALL_USERS_KEY, JSON.stringify(allUsers));
            };

            // --- Handlers ---

            const handleWatchAd = () => {
                if (userState.daily_ads_watched >= DAILY_AD_LIMIT) {
                    tg.showAlert("‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶ï‡¶æ‡¶ú ‡¶∂‡ßá‡¶∑");
                    return;
                }

                loadingModal.classList.remove('hidden');
                watchAdBtn.disabled = true;

                setTimeout(() => {
                    loadingModal.classList.add('hidden');
                    userState.points += AD_POINT;
                    userState.daily_ads_watched += 1;
                    saveState();
                    updateUI();
                    tg.showAlert(`+${AD_POINT} TK ‡¶Ø‡ßã‡¶ó ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!`);
                    watchAdBtn.disabled = false;
                }, 3000); // 3 seconds for testing, change to 15000 for production
            };

            const handleGenerateReferralMessage = async () => {
                geminiModal.classList.remove('hidden');
                generatedMessageTextarea.value = "‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
                copyGeneratedBtn.disabled = true;

                const systemPrompt = "You are a Bengali marketing expert. Generate a short, engaging referral message in Bengali for RDS TEAM Earning Mini App. Include the referral link and benefits.";

                const userQuery = "Generate the Bengali referral message for the RDS TEAM Earning Mini App.";

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                try {
                    const response = await fetchWithRetry(GEMINI_API_URL + API_KEY, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();
                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Gemini ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§";
                    
                    generatedMessageTextarea.value = text;
                    copyGeneratedBtn.disabled = false;
                    
                } catch (error) {
                    console.error("Gemini API Error:", error);
                    generatedMessageTextarea.value = "‡¶®‡ßá‡¶ü‡¶ì‡¶Ø‡¶º‡¶æ‡¶∞‡ßç‡¶ï ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶¨‡¶æ ‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶§‡ßç‡¶∞‡ßÅ‡¶ü‡¶ø‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£‡ßá ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§";
                }
            };
            
            const copyGeneratedMessage = () => {
                const messageText = generatedMessageTextarea.value;
                const tempInput = document.createElement('textarea');
                tempInput.value = messageText;
                document.body.appendChild(tempInput);
                tempInput.select();
                try {
                    document.execCommand('copy');
                    tg.HapticFeedback.notificationOccurred('success');
                    tg.showAlert("‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
                    geminiModal.classList.add('hidden');
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    tg.showAlert("‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡•§ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤‡¶ø ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
                } finally {
                    document.body.removeChild(tempInput);
                }
            };

            const handleSubmitWithdraw = async (e) => {
                e.preventDefault();
                
                if (withdrawSubmitBtn.disabled) return;
                if (userState.referrals.length < MIN_REFERRALS_FOR_WITHDRAW) {
                    tg.showAlert("‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá 20 ‡¶ú‡¶® ‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶Ø‡¶º‡ßã‡¶ú‡¶®‡•§");
                    return;
                }

                const amount = parseFloat(amountInput.value);
                const method = methodSelect.value;
                const number = numberInput.value.trim();
                const wallet = walletSelectHidden.value; // 'main' or 'refer'
                
                if (isNaN(amount) || amount < MIN_WITHDRAW_AMOUNT) {
                    tg.showAlert(`‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ ‡¶Ö‡¶¨‡¶∂‡ßç‡¶Ø‡¶á ‡¶®‡ßç‡¶Ø‡ßÇ‡¶®‡¶§‡¶Æ ${MIN_WITHDRAW_AMOUNT} TK ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá‡•§`);
                    return;
                }
                
                let balanceToCheck = wallet === 'main' ? userState.points : userState.referral_points;

                if (amount > balanceToCheck) {
                    tg.showAlert(`‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ \( {wallet === 'main' ? '‡¶Æ‡ßá‡¶á‡¶®' : '‡¶∞‡ßá‡¶´‡¶æ‡¶∞'} ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏‡ßá ‡¶Ö‡¶™‡¶∞‡ßç‡¶Ø‡¶æ‡¶™‡ßç‡¶§ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶Ü‡¶õ‡ßá‡•§ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏: \){balanceToCheck.toFixed(2)} TK‡•§`);
                    return;
                }
                
                if (number.length < 10) {
                    tg.showAlert("‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡¶†‡¶ø‡¶ï ‡¶´‡ßã‡¶® ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶®‡•§");
                    return;
                }
                
                // Show confirmation before proceeding
                if (!confirm(`‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶Ø‡ßá \( {amount} TK ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶® ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶® ( \){method}: ${number})?`)) {
                    return;
                }

                // Deduct points instantly
                if (wallet === 'main') {
                    userState.points -= amount;
                } else {
                    userState.referral_points -= amount;
                }
                saveState();
                updateUI();

                // Build a message for the admin/bot
                const adminMessage = `
**üö® ‡¶®‡¶§‡ßÅ‡¶® ‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß! üö®**
**‡¶á‡¶â‡¶ú‡¶æ‡¶∞:** \( {userState.name} ( \){userState.username ? `@${userState.username}` : 'N/A'})
**‡¶á‡¶â‡¶ú‡¶æ‡¶∞ ‡¶Ü‡¶á‡¶°‡¶ø:** \`${userId}\`
**‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡ßá‡¶∞ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£:** ${amount.toFixed(2)} TK
**‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡ßá‡¶∞ ‡¶Æ‡¶æ‡¶ß‡ßç‡¶Ø‡¶Æ:** ${method}
**‡¶®‡¶Æ‡ßç‡¶¨‡¶∞:** \`${number}\`
**‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏ ‡¶â‡ßé‡¶∏:** ${wallet === 'main' ? '‡¶Æ‡ßá‡¶á‡¶® ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏' : '‡¶∞‡ßá‡¶´‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏'}
**‡¶Æ‡ßã‡¶ü ‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤:** ${userState.referrals.length} ‡¶ú‡¶®
`;

                const historyItem = {
                    id: Date.now(),
                    amount: amount,
                    method: method,
                    number: number,
                    wallet: wallet,
                    date: new Date().toISOString(),
                    status: 'Approve' // Initial status
                };
                
                // Add to history
                userState.history.push(historyItem);
                saveState();
                renderHistory();
                
                // --- Send Telegram Message to Admin (Bot Integration) ---
                const telegramApiUrl = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
                
                withdrawSubmitBtn.classList.add('loading');
                withdrawSubmitBtn.disabled = true;

                try {
                    await fetchWithRetry(telegramApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chat_id: ADMIN_CHAT_ID,
                            text: adminMessage,
                            parse_mode: 'Markdown'
                        })
                    });
                    
                    tg.HapticFeedback.notificationOccurred('success');
                    tg.showAlert("‡¶â‡¶§‡ßç‡¶§‡ßã‡¶≤‡¶®‡ßá‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß ‡¶∏‡¶´‡¶≤‡¶≠‡¶æ‡¶¨‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá! ‡¶Ö‡¶®‡ßÅ‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡ßá ‡¶™‡ßá‡¶Æ‡ßá‡¶®‡ßç‡¶ü‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");

                    // Clear form after successful submission
                    amountInput.value = '';
                    numberInput.value = '';
                    
                } catch (error) {
                    console.error("Error sending Telegram message:", error);
                    // If Telegram fails, revert points and notify user
                    tg.HapticFeedback.notificationOccurred('error');
                    tg.showAlert("‡¶Ö‡¶®‡ßÅ‡¶∞‡ßã‡¶ß ‡¶ú‡¶Æ‡¶æ ‡¶¶‡¶ø‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ü‡¶æ‡¶ï‡¶æ ‡¶´‡ßá‡¶∞‡¶§ ‡¶¶‡ßá‡¶ì‡ßü‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§");
                    
                    if (wallet === 'main') {
                        userState.points += amount;
                    } else {
                        userState.referral_points += amount;
                    }
                    
                    // Also remove the history item that failed to send
                    userState.history = userState.history.filter(item => item.id !== historyItem.id);
                    
                    saveState();
                    updateUI();
                } finally {
                    withdrawSubmitBtn.classList.remove('loading');
                    withdrawSubmitBtn.disabled = false;
                }
            };
            
            const copyReferralLink = () => {
                const linkText = referralLinkElem.value;
                const tempInput = document.createElement('textarea');
                tempInput.value = linkText;
                document.body.appendChild(tempInput);
                tempInput.select();
                try {
                    document.execCommand('copy');
                    tg.HapticFeedback.notificationOccurred('success');
                    tg.showAlert("‡¶∞‡ßá‡¶´‡¶æ‡¶∞‡ßá‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá!");
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    tg.showAlert("‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•‡•§ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤‡¶ø ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
                } finally {
                    document.body.removeChild(tempInput);
                }
            };

            const setupNavigation = () => {
                const navButtons = document.querySelectorAll('.nav-btn');
                const pages = document.querySelectorAll('.page');
                navButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const pageId = button.dataset.page;
                        pages.forEach(page => page.classList.remove('active'));
                        document.getElementById(pageId).classList.add('active');
                        navButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                    });
                });
            };

            const initApp = () => {
                if (tg) {
                    tg.ready();
                    tg.expand();
                    tg.setHeaderColor('#1e1e1e');
                    tg.setBackgroundColor('#121212');
                }
                
                // Load state first to get user data
                loadState();
                
                // App Event Listeners
                watchAdBtn.addEventListener('click', handleWatchAd);
                withdrawForm.addEventListener('submit', handleSubmitWithdraw);
                copyReferralBtn.addEventListener('click', copyReferralLink);
                
                // Gemini Feature Listeners 
                generateMessageBtn.addEventListener('click', handleGenerateReferralMessage);
                closeModalBtn.addEventListener('click', () => geminiModal.classList.add('hidden'));
                copyGeneratedBtn.addEventListener('click', copyGeneratedMessage);
                
                setupNavigation();
                
                // Final UI update
                updateUI(); 
            };

            initApp();
        });
    </script>
</body>


</html>