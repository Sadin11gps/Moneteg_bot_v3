<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Earning ~×•RDS TEAM•×~</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap');
        :root {
            --font-family: 'Nunito', sans-serif;
            --bg-color: #121212; --secondary-bg: #1e1e1e; --text-color: #ffffff; --subtle-text: #b0b0b0;
            --primary-color: #3498db; --accent-color: #f39c12; --sparkle-color: #e74c3c; --success-color: #2ecc71;
            --danger-color: #e74c3c; --glow-shadow: 0 0 10px rgba(231, 76, 60, 0.4); --card-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            --border-radius: 12px;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--text-color); line-height: 1.6; padding-bottom: 70px; }
        .container { max-width: 500px; margin: 0 auto; padding: 0 15px; }
        .page { display: none; padding-top: 10px; min-height: calc(100vh - 80px); }
        .page.active { display: block; }
        .card, .referral-box { background-color: var(--secondary-bg); padding: 15px; border-radius: var(--border-radius); box-shadow: var(--card-shadow); margin-bottom: 15px; }
        .profile-header { display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid #333; margin-bottom: 20px; }
        .user-photo-placeholder { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 3px solid var(--primary-color); }
        .user-info .user-name { font-size: 1.4rem; margin: 0; color: var(--sparkle-color); }
        .user-info .user-id-text { font-size: 0.8rem; color: var(--subtle-text); margin: 0; }
        .balance-section { display: flex; justify-content: space-around; text-align: center; }
        .balance-card { flex: 1; padding: 15px; margin: 0 5px; border-radius: var(--border-radius); background: #252525; box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5); border: 1px solid #333; }
        .balance-label { font-size: 0.8rem; color: var(--subtle-text); margin-bottom: 5px; }
        .balance-value { font-size: 1.5rem; font-weight: 700; color: var(--success-color); }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px; }
        .stat-card { background-color: #252525; padding: 15px; border-radius: var(--border-radius); text-align: center; border-left: 5px solid var(--accent-color); }
        .stat-icon { color: var(--accent-color); font-size: 1.5rem; margin-bottom: 5px; }
        .stat-value { font-size: 1.6rem; font-weight: 700; color: var(--sparkle-color); }
        .stat-label { font-size: 0.8rem; color: var(--subtle-text); }
        .btn-primary { display: block; width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 1rem; font-weight: 700; cursor: pointer; background-color: var(--primary-color); color: white; }
        .btn-primary:disabled { background-color: #5d6d7e; opacity: 0.7; }
        .referral-input-group { display: flex; margin-bottom: 15px; }
        #referral-link-input { flex-grow: 1; padding: 10px; border: 1px solid #444; border-radius: 8px 0 0 8px; background-color: #2c2c2c; color: white; }
        .btn-copy { padding: 10px 15px; border-radius: 0 8px 8px 0; background-color: var(--accent-color); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; display: flex; justify-content: space-around; background-color: #1e1e1e; border-top: 1px solid #333; z-index: 1000; max-width: 500px; margin: 0 auto; }
        .nav-btn { background: none; border: none; color: var(--subtle-text); padding: 10px 0; flex: 1; font-size: 0.7rem; display: flex; flex-direction: column; align-items: center; cursor: pointer; }
        .nav-btn i { font-size: 1.2rem; margin-bottom: 4px; }
        .nav-btn.active { color: var(--sparkle-color); }
        .loader { border: 5px solid #333; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto; }
        .hidden { display: none !important; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <!-- তোর পুরো HTML একদম আগের মতোই আছে (হোম, টাস্ক, উইথড্র, হিস্ট্রি, সাপোর্ট, মোডাল) -->
        <!-- শুধু কয়েকটা অংশ দেখালাম, বাকি তোর আসল ফাইল থেকে কপি করা -->

        <div id="home-page" class="page active">
            <div class="profile-header">
                <img id="user-photo" src="https://placehold.co/60x60/3498db/ffffff?text=L" class="user-photo-placeholder">
                <div class="user-info">
                    <h1 class="user-name" id="user-name">Loading...</h1>
                    <p class="user-id-text">ID: <span id="user-id">Loading...</span></p>
                </div>
            </div>

            <div class="balance-section mb-4">
                <div class="balance-card">
                    <div class="balance-label">মোট মেইন ব্যালেন্স</div>
                    <div class="balance-value" id="main-balance">0.00 TK</div>
                </div>
                <div class="balance-card">
                    <div class="balance-label">মোট রেফার ব্যালেন্স</div>
                    <div class="balance-value" id="refer-balance">0.00 TK</div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="total-referrals">0</div>
                    <div class="stat-label">মোট রেফারেল</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="daily-ads-watched">0</div>
                    <div class="stat-label">আজকের কাজ</div>
                </div>
            </div>

            <div class="referral-box mt-4">
                <h3 style="color: var(--sparkle-color); margin-bottom: 10px;">রেফারেল লিংক</h3>
                <div class="referral-input-group">
                    <input type="text" id="referral-link-input" value="Loading..." readonly>
                    <button id="copy-referral-btn" class="btn-copy">Copy</button>
                </div>
                <button id="generate-message-btn" class="btn-primary mt-3" style="background-color: #8e44ad;">
                    রেফারেল মেসেজ তৈরি করুন (Gemini AI)
                </button>
            </div>
        </div>

        <!-- বাকি সব পেজ (task, withdraw, history, support) + মোডাল তোর আসল ফাইলের মতোই আছে -->
    </div>

    <div class="bottom-nav">
        <button class="nav-btn active" data-page="home-page">হোম</button>
        <button class="nav-btn" data-page="task-page">কাজ</button>
        <button class="nav-btn" data-page="withdraw-page">উত্তোলন</button>
        <button class="nav-btn" data-page="history-page">ইতিহাস</button>
        <button class="nav-btn" data-page="support-page">সাপোর্ট</button>
    </div>

    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src='//libtl.com/sdk.js' data-zone='10203066' data-sdk='show_10203066'></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const tg = window.Telegram.WebApp;
            if (!tg || !tg.initDataUnsafe || !tg.initDataUnsafe.user) {
                document.body.innerHTML = "<h1 style='color:red;text-align:center;padding:50px;'>টেলিগ্রাম থেকে খুলুন!</h1>";
                return;
            }
            tg.ready(); tg.expand();

            // ====== এটাই মূল ফিক্স (শুধু এই অংশটা চেঞ্জ করেছি) ======
            const BOT_USERNAME = "vote_rds_bot";
            const REFERRAL_BONUS = 30;
            const ALL_USERS_KEY = 'rds_team_all_users_2025';
            const userId = tg.initDataUnsafe.user.id.toString();
            const startParam = tg.initDataUnsafe.start_param || '';

            let allUsers = JSON.parse(localStorage.getItem(ALL_USERS_KEY) || '{}');

            // ইউজার লোড/তৈরি
            if (!allUsers[userId]) {
                allUsers[userId] = {
                    id: userId,
                    name: (tg.initDataUnsafe.user.first_name || '') + ' ' + (tg.initDataUnsafe.user.last_name || ''),
                    username: tg.initDataUnsafe.user.username || null,
                    points: 0,
                    referral_points: 0,
                    referrals: [],
                    daily_ads_watched: 0,
                    last_ad_date: new Date().toDateString(),
                    history: [],
                    initial_referral_processed: false
                };
            }
            let userState = allUsers[userId];

            // ====== রেফার প্রসেসিং (প্রথমেই হবে) ======
            if (startParam && startParam !== userId && !userState.initial_referral_processed) {
                const referrerId = startParam;
                if (allUsers[referrerId] && !allUsers[referrerId].referrals.includes(userId)) {
                    allUsers[referrerId].referrals.push(userId);
                    allUsers[referrerId].referral_points += REFERRAL_BONUS;
                    userState.initial_referral_processed = true;
                    localStorage.setItem(ALL_USERS_KEY, JSON.stringify(allUsers));
                    tg.showAlert(`অভিনন্দন! \( {allUsers[referrerId].name} এর রেফারেল। তাকে \){REFERRAL_BONUS} TK দেওয়া হয়েছে!`);
                }
            }

            const saveState = () => {
                allUsers[userId] = userState;
                localStorage.setItem(ALL_USERS_KEY, JSON.stringify(allUsers));
            };

            // ====== UI আপডেট ফাংশন (এটা ছিল না বলে লোডিং-এ আটকে থাকতো) ======
            const updateUI = () => {
                document.getElementById('user-name').textContent = userState.name || 'User';
                document.getElementById('user-id').textContent = userId;
                document.getElementById('main-balance').textContent = userState.points.toFixed(2) + ' TK';
                document.getElementById('refer-balance').textContent = userState.referral_points.toFixed(2) + ' TK';
                document.getElementById('total-referrals').textContent = userState.referrals.length;
                document.getElementById('daily-ads-watched').textContent = userState.daily_ads_watched;
                document.getElementById('referral-link-input').value = `https://t.me/\( {BOT_USERNAME}?start= \){userId}`;
            };

            // ====== বাকি সব তোর আগের কোড (অ্যাড, উইথড্র, জেমিনি, নেভিগেশন) ======
            // ... তোর পুরো কোড এখানে থাকবে ...

            // শেষে UI আপডেট করা হবে
            updateUI();
            saveState();
        });
    </script>
</body>
                        </html>
